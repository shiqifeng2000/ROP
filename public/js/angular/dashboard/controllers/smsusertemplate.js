"use strict";define(["../../services"],function(cta){return["$rootScope","$scope","$q","$location","$http","$timeout","$mdDialog","MiscTool","ROPDateUtil",function($rootScope,$scope,$q,$location,$http,$timeout,$mdDialog,MiscTool,ROPDateUtil){function showTempDialog(ev,pipeList,temp){$mdDialog.show({controller:CreateTempCtrl,template:'\n          <md-dialog aria-label="添加模板" class="form" aria-describedby="quick edit">\n              <md-toolbar>\n                <div class="md-toolbar-tools">\n                  <md-icon md-svg-icon="navigation:ic_apps_24px"></md-icon>\n                  <h3><span>添加模板</span></h3>\n                  <md-button class="md-icon-button md-primary md-hue-1" aria-label="Settings" ng-click="close()">\n                    <md-icon md-svg-icon="content:ic_clear_24px"></md-icon>\n                  </md-button>\n                </div>\n              </md-toolbar>\n              <md-dialog-content>\n                <form class="md-dialog-content" name="chargeForm" ng-submit="save()" autocomplete="off">\n                  <div class="input-container">\n                      <label style="width: 108px;">通道名称</label>\n                      <md-menu class="md-dropdown cool" md-offset="1 50">\n                          <md-button ng-click="$mdOpenMenu($event)" class="md-raised md-primary md-hue-1" md-theme="dracular" aria-label="data control" ng-disabled="refreshing"  style="width:200px;">\n                              <span ng-bind="currentPipe.channel_name"></span>\n                              <md-icon class="" md-svg-icon="navigation:ic_arrow_drop_down_24px"></md-icon>\n                          </md-button>\n                          <md-menu-content class="md-dropdown-content cool" style="width: 200px">\n                              <md-menu-item ng-repeat="pipe in pipeList track by $index"><md-button ng-click="select(pipe)">{{pipe.channel_name}}</md-button></md-menu-item>\n                          </md-menu-content>\n                      </md-menu>\n                  </div>\n                  <md-input-container class="md-block">\n                    <label>模板内容</label>\n                    <textarea ng-model="temp.template_content" md-maxlength="200" rows="3" md-select-on-focus style="overflow: auto" required></textarea>\n                  </md-input-container>\n                  <a href="http://open.rongcapital.cn/welcome/document/9ea34b74-7545-41fc-932f-24382816e5e8" target="_blank" class="readmore" style="font-size: 1rem">\n                    <span>模版说明</span>\n                  </a>\n                </form>\n                <div class="app-loading" ng-if="refreshing">\n                  <md-progress-circular md-mode="indeterminate"></md-progress-circular>\n                </div>\n              </md-dialog-content>\n              <md-dialog-actions layout="row">\n                <div class="message" ng-if="error">\n                  <span ng-bind="error"></span>\n                </div>\n                <md-button ng-click="save()" type="submit">保存</md-button>\n              </md-dialog-actions>\n            </md-dialog>',autoWrap:!1,targetEvent:ev,clickOutsideToClose:!0,parent:angular.element(document.querySelector("body>section>md-content")),locals:{pipeList:pipeList,temp:temp}})}function getPipeList(){return $scope.loading=!0,$scope.ajax("init").then(function(data){if("boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success){var pipeList=data.channel_list;pipeList.unshift(defaultPipe),$scope.pipeList=pipeList}})["finally"](function(){$scope.loading=!1})}var pipeQ=void 0;$scope.columns=[{text:"模板内容",name:"template_content",style:{"text-align":"left"}},{text:"用户通道",name:"channel_name",style:{"text-align":"center",width:"180px"}},{text:"创建人",name:"create_user_name",style:{"text-align":"center",width:"180px"}},{text:"模板状态",name:"template_status",style:{"text-align":"center",width:"120px"}},{text:"添加时间",name:"rx_insertTime",style:{"text-align":"center",width:"240px"}}];var defaultPipe={channel_id:"",channel_name:"短信全部通道"};$scope.tempList=[],$scope.staList=[{sta_name:"全部状态",recharge_status:""},{sta_name:"已审核",recharge_status:"1"},{sta_name:"未审核",recharge_status:"0"}],$scope.pipeList=[defaultPipe],$scope.reset=function(){$scope.loading=!0,$scope.currentPipe=defaultPipe,$scope.currentSta=$scope.staList[0],$scope.maxdate=new Date,$scope.mindate=new Date((new Date).setFullYear((new Date).getFullYear()-1)),pipeQ=getPipeList(),$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.searcher=function(index,size){return $scope.refreshing=!0,pipeQ.then(function(){var previous=$scope.tempList&&$scope.tempList._select;return $scope.ajax("list",{pageindex:index||$scope.pageIndex,pagesize:size||$scope.pageSize,user_name:$rootScope.profile&&$rootScope.profile.login_user_name,user_channel_id:$scope.currentPipe&&$scope.currentPipe.channel_id,template_status:$scope.currentSta&&$scope.currentSta.recharge_status},function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?($scope.tempList=data.template_list,$scope.total=data.list_count,$scope.tempList&&$scope.tempList[0]&&(previous?$scope.tempList._select=[].concat.apply([],$scope.tempList.map(function(r){return previous.template_id==r.template_id?[r]:[]}))[0]:$scope.tempList._select=$scope.tempList[0])):($rootScope.alert(data.msg),$scope.total=0)},function(){$scope.total=0})["finally"](function(){$scope.refreshing=!1})})},$scope.research=function(){$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.creatTemp=function(ev){var pipeList=$scope.pipeList.filter(function(pipe){return""!==pipe.channel_id}),temp={template_content:""};showTempDialog(ev,pipeList,temp)},$scope.editTemp=function(ev){var pipeList=$scope.pipeList.filter(function(pipe){return""!==pipe.channel_id}),temp={template_id:$scope.tempList._select&&$scope.tempList._select.template_id,template_content:$scope.tempList&&$scope.tempList._select.template_content,user_channel_id:$scope.tempList&&$scope.tempList._select.user_channel_id};showTempDialog(ev,pipeList,temp)},$scope.deleteTemp=function(){if(!$scope.refreshing&&$scope.tempList._select)return $rootScope.confirm("确定要删除?",function(){$scope.refreshing=!0,$scope.ajax("delete",{template_id:$scope.tempList._select&&$scope.tempList._select.template_id}).then(function(data){("boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success)&&$scope.research()})["finally"](function(){$scope.refreshing=!1})})},$scope.selectPipe=function(pipe){$scope.currentPipe=pipe,$scope.research()},$scope.selectSta=function(status){$scope.currentSta=status,$scope.research()};var CreateTempCtrl=function(scope,pipeList,temp){if(scope.pipeList=pipeList,scope.temp=temp,temp.template_id){for(var i=0;i<pipeList.length;i++)if(pipeList[i].channel_id===temp.user_channel_id){scope.currentPipe=pipeList[i];break}}else scope.currentPipe=pipeList[0];scope.save=function(){return scope.chargeForm.$invalid?(scope.chargeForm.$error.required&&scope.chargeForm.$error.required.forEach(function(r){r.$setDirty(!0)}),scope.chargeForm.$error.maxlength&&scope.chargeForm.$error.maxlength.forEach(function(r){r.$setDirty(!0)}),void(scope.error="请检查输入是否正确")):(scope.refreshing=!0,$http.post("/agent",{module:"dashboard",partial:"smsusertemplatelist",api:"save",param:{user_name:$rootScope.profile&&$rootScope.profile.login_user_name,channel_id:scope.currentPipe&&scope.currentPipe.channel_id,template_content:scope.temp.template_content,template_id:scope.temp.template_id}}).then(function(body){return"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?(scope.close(),scope.temp.template_id?$scope.searcher():$scope.research(),body.data):void(scope.error=body.data.msg)},function(why){return scope.error=why,$q.reject(why)})["finally"](function(){scope.refreshing=!1}))},scope.select=function(pipe){scope.currentPipe=pipe},scope.close=function(){$mdDialog.hide()}};$scope.reset(),window.test=$scope}]});