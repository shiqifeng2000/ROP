"use strict";define(["../../services"],function(cta){return["$rootScope","$scope","$q","$location","$http","$timeout","$mdDialog","MiscTool",function($rootScope,$scope,$q,$location,$http,$timeout,$mdDialog,MiscTool){$scope.columns=[{text:"开始IP",name:"ip_start",style:{width:"196px","text-align":"center"}},{text:"结束IP",name:"ip_end",style:{width:"196px","text-align":"center"}},{text:"备注",name:"remark"},{text:"添加时间",name:"rx_insertTime",formatter:function(str){var result="";try{result=new Date(str).Format("yyyy-MM-dd HH:mm:ss")}catch(e){}return result},style:{width:"196px","text-align":"center"}}],$scope.keyword="",$scope.batch=!1,$scope.pageIndex=1,$scope.pageSize=new Number(10),$scope.tableData=[],$scope.total=0,$scope.reset=function(){$scope.keyword="",$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.research=function(){$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.searcher=function(index,size){$scope.refreshing=!0;var previous=$scope.tableData&&$scope.tableData._select;return $scope.ajax("list",{pageindex:index||$scope.pageIndex,pagesize:size||$scope.pageSize,ip:$scope.keyword},function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?($scope.tableData=data.ip_list,$scope.tableData&&$scope.tableData[0]&&(previous?$scope.tableData._select=[].concat.apply([],$scope.tableData.map(function(r){return previous.id==r.id?[r]:[]}))[0]:$scope.tableData._select=$scope.tableData[0]),$scope.total=data.list_count):($rootScope.alert(data.msg),$scope.total=0)},function(){$scope.total=0})["finally"](function(){$scope.refreshing=!1})},$scope.canVisistIP=function(){return $scope.tableData._select},$scope.deleteIP=function(){return $scope.tableData&&$scope.tableData._select?$rootScope.confirm("请确认是否要删除此IP？",function(){return $scope.ajax("delete",{id:$scope.tableData._select.id},function(data){$scope.research(),$rootScope.warn("删除成功",1)})}):$q.reject()};var IPController=function(scope,$mdDialog,ip){if(scope.range=!!(ip&&ip.ip_end&&/^([1-9]|[1-9][0-9]|[1][0-9][0-9]|2[0-4][0-9]|25[0-5]\.){3}[1-9]|[1-9][0-9]|[1][0-9][0-9]|2[0-4][0-9]|25[0-5]$/.test(ip.ip_end)&&ip.ip_start!=ip.ip_end),scope.singleIP=[172,20,1,1],scope.rangeIPEnd=[172,20,1,1],scope.remark=ip&&ip.remark||"",ip){ip.ip_start&&(scope.singleIP=ip.ip_start.split(".")),ip.ip_end&&(scope.rangeIPEnd=ip.ip_end.split("."));for(var i=0;i<scope.singleIP.length;i++)!scope.singleIP[i]||Number.isNaN(scope.singleIP[i])?scope.singleIP[i]=0:scope.singleIP[i]=Number(scope.singleIP[i]),3==i&&0==scope.singleIP[i]&&(scope.singleIP[i]=1);if(!ip.ip_end&&Number(scope.singleIP.join(""))>Number(scope.rangeIPEnd.join("")))scope.rangeIPEnd=scope.singleIP;else for(var i=0;i<scope.rangeIPEnd.length;i++)!scope.rangeIPEnd[i]||Number.isNaN(scope.rangeIPEnd[i])?scope.rangeIPEnd[i]=0:scope.rangeIPEnd[i]=Number(scope.rangeIPEnd[i])}scope.bigger3=function(){return!scope.range||Number(scope.rangeIPEnd[2]||"")>=Number(scope.singleIP[2]||"")},scope.bigger4=function(){return!scope.range||(Number(scope.rangeIPEnd[2]||"")>Number(scope.singleIP[2]||"")||Number(scope.rangeIPEnd[2]||"")==Number(scope.singleIP[2]||"")&&Number(scope.rangeIPEnd[3]||"")>=Number(scope.singleIP[3]||""))},scope.triggerValid3=function(){scope.ipForm.ip3.$validate(),scope.ipForm.ip4.$validate(),scope.ipForm.ip4end&&scope.ipForm.ip4end.$validate()},scope.triggerValid4=function(){scope.ipForm.ip3.$validate(),scope.ipForm.ip4.$validate(),scope.ipForm.ip3end&&scope.ipForm.ip3end.$validate()},scope.triggerValidEnd=function(){scope.ipForm.ip3end&&scope.ipForm.ip3end.$validate(),scope.ipForm.ip4end&&scope.ipForm.ip4end.$validate()},scope.close=function(){return $mdDialog.hide()},window.test1=scope,scope.save=function(){if(!scope.loading&&!scope.ipForm.$invalid)return scope.loading=!0,$http.post("/agent",{module:"dashboard",partial:"ipwhitelist",api:"put",param:{id:ip?ip.id:"",ip_start1:scope.singleIP[0],ip_end1:scope.singleIP[0],ip_start2:scope.singleIP[1],ip_end2:scope.singleIP[1],ip_start3:scope.singleIP[2],ip_end3:scope.range?scope.rangeIPEnd[2]:scope.singleIP[2],ip_start4:scope.singleIP[3],ip_end4:scope.range?scope.rangeIPEnd[3]:scope.singleIP[3],remark:scope.remark}}).then(function(body){return"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?(ip?scope.close().then(function(){$scope.searcher()}):scope.close().then($scope.research),body.data):(scope.error=body.data.msg,$q.reject(body.data.msg))},function(why){return scope.error=why,$q.reject(why)})["finally"](function(){scope.loading=!1})}};$scope.showIPDialog=function(ev,ip){$scope.refreshing||$mdDialog.show({controller:IPController,template:'<md-dialog aria-label="Mango" class="ip-dialog">\n                          <md-toolbar>\n                              <div class="md-toolbar-tools">\n                                  <h3><span>添加IP</span></h3>\n                              </div>\n                          </md-toolbar>\n                          <md-dialog-content class="md-dialog-content">\n                              <div class="md-dialog-content-body">\n                                  <form name="ipForm" autocomplete="off">\n                                     <md-radio-group ng-model="range">\n                                        <md-radio-button class="md-primary" aria-label="单选按钮" ng-value="false">单个IP</md-radio-button>\n                                        <md-radio-button class="md-primary" ng-value="true">IP段</md-radio-button>\n                                     </md-radio-group>\n                                     \n                                     <div class="input-container">\n                                        <div class="input-row">\n                                            <input ng-model="singleIP[0]" name="ip1" type="text" ng-required="true" autocomplete="off" pattern="^([1-9]?[0-9]|[1][0-9][0-9]|2[0-4][0-9]|25[0-5])$">\n                                            <span class="sep">.</span>\n                                            <input ng-model="singleIP[1]" name="ip2" type="text" ng-required="true" autocomplete="off" pattern="^([1-9]?[0-9]|[1][0-9][0-9]|2[0-4][0-9]|25[0-5])$">\n                                            <span class="sep">.</span>\n                                            <input ng-model="singleIP[2]" name="ip3" type="text" ng-required="true" autocomplete="off" pattern="^([1-9]?[0-9]|[1][0-9][0-9]|2[0-4][0-9]|25[0-5])$" ng-model-options="{ allowInvalid: true }" ng-change="triggerValidEnd()">\n                                            <span class="sep">.</span>\n                                            <input ng-model="singleIP[3]" name="ip4" type="text" ng-required="true" autocomplete="off" pattern="^([1-9]|[1-9][0-9]|[1][0-9][0-9]|2[0-4][0-9]|25[0-5])$" ng-model-options="{ allowInvalid: true }" ng-change="triggerValidEnd()">                     \n                                        </div>\n                                        <div class="input-row" ng-if="range">\n                                            <input ng-model="singleIP[0]" name="ip1end" type="text" ng-required="true" autocomplete="off" pattern="^([1-9]?[0-9]|[1][0-9][0-9]|2[0-4][0-9]|25[0-5])$" disabled>\n                                            <span class="sep">.</span>\n                                            <input ng-model="singleIP[1]" name="ip2end" type="text" ng-required="true" autocomplete="off" pattern="^([1-9]?[0-9]|[1][0-9][0-9]|2[0-4][0-9]|25[0-5])$" disabled>\n                                            <span class="sep">.</span>\n                                            <input class="dirty-check" ng-model="rangeIPEnd[2]" name="ip3end" type="text" ng-required="true" autocomplete="off" pattern="^([1-9]?[0-9]|[1][0-9][0-9]|2[0-4][0-9]|25[0-5])$" custom-validate="bigger3" ng-model-options="{ allowInvalid: true }" ng-change="triggerValid3()">\n                                            <span class="sep">.</span>\n                                            <input class="dirty-check" ng-model="rangeIPEnd[3]" name="ip4end" type="text" ng-required="true" autocomplete="off" pattern="^([1-9]|[1-9][0-9]|[1][0-9][0-9]|2[0-4][0-9]|25[0-5])$" custom-validate="bigger4" ng-model-options="{ allowInvalid: true }" ng-change="triggerValid4()">                     \n                                        </div>                                       \n                                     </div>\n                                     \n                                     <div class="remark-container">\n                                        <h3 class="title">备注</h3>\n                                        <input name="remark" class="remark" placeholder="请输入备注" ng-model="remark" maxlength="200" unicode-length-validator></textarea>                                    \n                                     </div>\n                                  </form>\n                              </div>\n                              <div class="hint"><span>设置IP白名单后，只有白名单IP范围内的IP可以调用API，请谨慎操作</span></div>\n                              <div class="messages" ng-class={\'has-error\':error} >\n                                <div class="message" ng-if="error" ng-bind="error"></div>\n                              </div>\n                              <div ng-messages="ipForm.ip1.$error" class="messages" ng-class={\'has-error\':ipForm.ip1.$invalid}>\n                                <div ng-message="required" class="message">您输入的IPv4地址第一段必须完整</div>\n                                <div ng-message="pattern" class="message">您输入的IPv4地址第一段必须介于0-255间</div>\n                              </div>\n                              <div ng-messages="ipForm.ip2.$error" class="messages" ng-class={\'has-error\':ipForm.ip2.$invalid}>\n                                <div ng-message="required" class="message">您输入的IPv4地址第二段必须完整</div>\n                                <div ng-message="pattern" class="message">您输入的IPv4地址第二段必须介于0-255间</div>\n                              </div>\n                              <div ng-messages="ipForm.ip3.$error" class="messages" ng-class={\'has-error\':ipForm.ip3.$invalid}>\n                                <div ng-message="required" class="message">您输入的IPv4地址第三段必须完整</div>\n                                <div ng-message="pattern" class="message">您输入的IPv4地址第三段必须介于0-255间</div>\n                              </div>\n                              <div ng-messages="ipForm.ip4.$error" class="messages" ng-class={\'has-error\':ipForm.ip4.$invalid}>\n                                <div ng-message="required" class="message">您输入的IPv4地址第四段必须完整</div>\n                                <div ng-message="pattern" class="message">您输入的IPv4地址第四段必须介于1-255间，末位不能为0</div>\n                              </div>\n                              <div ng-messages="ipForm.ip3end.$error" class="messages" ng-class={\'has-error\':ipForm.ip3end.$invalid}>\n                                <div ng-message="required" class="message">您输入的IPv4结束地址第三段必须完整</div>\n                                <div ng-message="pattern" class="message">您输入的IPv4结束地址第三段必须介于0-255间</div>\n                                <div ng-message="customValidate" class="message">您输入的IPv4结束地址须大于起始地址</div>\n                              </div>\n                              <div ng-messages="ipForm.ip4end.$error" class="messages" ng-class={\'has-error\':ipForm.ip4end.$invalid}>\n                                <div ng-message="required" class="message">您输入的IPv4结束地址第四段必须完整</div>\n                                <div ng-message="pattern" class="message">您输入的IPv4结束地址第四段必须介于1-255间</div>\n                                <div ng-message="customValidate" class="message">您输入的IPv4结束地址须大于起始地址</div>\n                              </div>\n                              <div ng-messages="ipForm.remark.$error" class="messages" ng-class={\'has-error\':ipForm.remark.$invalid}>\n                                <div ng-message="validUnicodeLength" class="message">您的输入过长，Unicode字符集不能超过250位</div>\n                              </div>\n                              <div class="app-loading" ng-if="loading">\n                                  <md-progress-circular md-mode="indeterminate"></md-progress-circular>\n                              </div>\n                          </md-dialog-content>\n                          <md-dialog-actions layout="row">\n                            <md-button ng-click="close()">\n                              取消\n                            </md-button>\n                            <md-button ng-click="save()" ng-disabled="loading">\n                              保存\n                            </md-button>\n                          </md-dialog-actions>\n                      </md-dialog>',targetEvent:ev,clickOutsideToClose:!0,autoWrap:!1,parent:angular.element(document.querySelector("body>section>md-content")),locals:{ip:ip}})},window.test=$scope}]});