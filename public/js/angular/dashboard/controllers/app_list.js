"use strict";define([],function(cta){return["$rootScope","$scope","$q","$http","$timeout","$mdDialog","$location",function($rootScope,$scope,$q,$http,$timeout,$mdDialog,$location){function getAppList(index,size){$scope.refreshing=!0;var previous=$scope.appList&&$scope.appList._select;return $scope.ajax("app_list_get",{pageindex:index||$scope.pageIndex,pagesize:size||$scope.pageSize,app_name:$scope.keyword}).then(function(data){if("boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success){$scope.appList=data.app_list;$scope.appList.map(function(app){return app.app_id}).indexOf(previous);$scope.appList&&$scope.appList[0]&&(previous?$scope.appList._select=[].concat.apply([],$scope.appList.map(function(r){return previous.app_id==r.app_id?[r]:[]}))[0]:$scope.appList._select=$scope.appList[0]),$scope.total=data.list_count}else $rootScope.warn(data.msg),$scope.total=0},function(){$scope.total=0})["finally"](function(){$scope.refreshing=!1})}function getApiList(index,size){return $scope.refreshing=!0,$scope.apiList=[],getCategoryListQ.then(function(){return"applist"!=$rootScope.tab.key?$q.reject():$scope.ajax("1"===$scope.hasApplied?"api_list_get":"api_unapplied_list_get",{pageindex:index||$scope.pageIndexApi,pagesize:size||$scope.pageSizeApi,api_name:$scope.keywordApi,app_id:$scope.appList._select&&$scope.appList._select.app_id,cat_id:$scope.currentCat.cat_id,status:"1"===$scope.hasApplied?$scope.currentSta.sta_id:void 0}).then(function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?($scope.apiList=data.api_list,"1"===$scope.hasApplied&&$scope.apiList.forEach(function(api){"免审核"===api.apply_status&&(api._locked=!0)}),$scope.totalApi=data.list_count):($rootScope.alert(data.msg),$scope.totalApi=0)},function(){$scope.totalApi=0})["finally"](function(){$scope.refreshing=!1})})}function getCategoryList(){return $scope.refreshing=!0,$scope.ajax("api_category_list_get",{pageindex:1,pagesize:999}).then(function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?$scope.catList=[{cat_id:"",cat_name:"全部类型"}].concat(data.data_list):$rootScope.alert(data.msg)})["finally"](function(){$scope.refreshing=!1})}function showAppDialog(ev,app,fromApp){$mdDialog.show({controller:CreateAppCtrl,template:'\n          <md-dialog aria-label="{{fromApp?\'复制应用\':(app.app_id?\'修改应用\':\'添加应用\')}}" class="form" aria-describedby="quick edit">\n              <md-toolbar>\n                <div class="md-toolbar-tools">\n                  <md-icon md-svg-icon="navigation:ic_apps_24px"></md-icon>\n                  <h3><span ng-bind="fromApp?\'复制应用\':(app.app_id?\'修改应用\':\'添加应用\')"></span></h3>\n                  <md-button class="md-icon-button md-primary md-hue-1" aria-label="Settings" ng-click="close()">\n                    <md-icon md-svg-icon="content:ic_clear_24px"></md-icon>\n                  </md-button>\n                </div>\n              </md-toolbar>\n              <md-dialog-content>\n                <form class="md-dialog-content postfix-input" name="appForm" autocomplete="off">\n                  <div class="input-container" ng-if="fromApp">\n                    <label>应用来源</label>\n                    <span ng-bind="fromApp.app_name" style="text-align: left;display: inline-block;width:200px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;position: static; padding-left: 8px;"></span>\n                  </div>\n                  <div class="input-container">\n                    <label>新应用名称</label>\n                    <input type="text" name="name" maxlength="100" spellcheck="false" ng-model="app.app_name"  style="text-align: left;" required/>\n                  </div>\n                  <md-input-container class="md-block">\n                    <label>备注</label>\n                    <textarea ng-model="app.remark" md-maxlength="100" rows="3" md-select-on-focus style="overflow: auto"></textarea>\n                  </md-input-container>\n                  <div class="hint" ng-if="fromApp" aria-hidden="false" style="font-size: 12px;\n                    line-height: 14px;height: 28px;\n                    transition: all .3s cubic-bezier(0.55,0,0.55,0.2);\n                    color: rgba(0,0,0,0.38);">开发者可以快速复制相似应用，新应用将自动被平台管理员审核，仅需供应商审核申请的API、开发者即可调用。\n                  </div>\n                  <div class="hint" ng-if="!fromApp && !app.app_id" aria-hidden="false" style="font-size: 12px;\n                    line-height: 14px;height: 28px;\n                    transition: all .3s cubic-bezier(0.55,0,0.55,0.2);\n                    color: rgba(0,0,0,0.38);">您可以创建新的应用。平台管理员审核后，您可以在“API设置”中申请供应商的API。供应商审核后您可以调用API。\n                  </div>\n                </form>\n                <div class="app-loading" ng-if="refreshing">\n                  <md-progress-circular md-mode="indeterminate"></md-progress-circular>\n                </div>\n              </md-dialog-content>\n              <md-dialog-actions layout="row">\n                <div class="message" ng-if="error">\n                  <span ng-bind="error"></span>\n                </div>\n                <md-button ng-click="save()" type="submit">保存</md-button>\n              </md-dialog-actions>\n            </md-dialog>',autoWrap:!1,targetEvent:ev,clickOutsideToClose:!0,parent:angular.element(document.querySelector("body>section>md-content")),locals:{app:app,fromApp:fromApp}})}var getAppListQ=void 0,getApiListQ=void 0,getCategoryListQ=void 0;$scope.hasApplied=!0,$scope.appList=[],$scope.columns=[{text:"查看账号",name:"",style:{"text-align":"center",width:"88px"},compile:'<md-icon class="preview_icon" md-svg-icon="/resource/application/preview-disabled.svg" ng-click="$parent.$parent.col.checkApp($parent.row)" style="width: 16px; height: 38px;"></md-icon>',checkApp:function(app){$scope.checkApp(app)}},{text:"应用名称",name:"app_name",style:{"text-align":"left"}},{text:"状态",name:"status",compile:'<md-button class="md-raised md-primary panel-icon rank high-rank" aria-label="data control" ng-if="$parent.$parent.row.status===\'未审核\'">未审核</md-button><md-button class="md-raised md-primary panel-icon low-rank rank" aria-label="data control" ng-if="$parent.$parent.row.status===\'已审核\'">已审核</md-button>',style:{"text-align":"center",width:"160px"}},{text:"添加时间",name:"rx_insertTime",style:{"text-align":"center",width:"160px"}}],$scope.reset=function(){$scope.mode=0,$scope.keyword="",$scope.pageIndex=1,$scope.pageSize=new Number(10),getCategoryListQ=getCategoryList()},$scope.reset(),$scope.searcher=function(index,size){return getAppListQ=getAppList(index,size)},$scope.research=function(){$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.setApp=function(event){$scope.mode=1,$scope.hasApplied="1",$scope.resetApi()},$scope.back=function(){$scope.mode=0,$scope.searcher()},$scope.resetApi=function(){$scope.currentCat=$scope.catList[0],$scope.currentSta=$scope.staList[0],$scope.apiList=[],"1"===$scope.hasApplied?$scope.columnsApi=columnApplied:$scope.columnsApi=columnNoApplied,$scope.keywordApi="",$scope.pageIndexApi=1,$scope.pageSizeApi=new Number(10)};var columnNoApplied=[{text:"API等级",name:"api_level",style:{"text-align":"center",width:"160px"},compile:'<md-button class="md-raised md-primary panel-icon rank high-rank" aria-label="data control" ng-if="$parent.$parent.row.api_level===\'0\'">高级</md-button><md-button class="md-raised md-primary panel-icon medium-rank rank" aria-label="data control" ng-if="$parent.$parent.row.api_level===\'2\'">中级</md-button><md-button class="md-raised md-primary panel-icon low-rank rank" aria-label="data control" ng-if="$parent.$parent.row.api_level===\'1\'">低级</md-button>'},{text:"API名称",name:"api_name",style:{"text-align":"left"},linker:{create:function(row){return Constant.protocol+"://"+Constant.host+":"+Constant.port+"/api/ApiPreview-"+row.api_id+".html"},target:"_blank"}},{text:"API描述",name:"api_title",style:{"text-align":"left"}}],columnApplied=columnNoApplied.concat([{text:"API状态",name:"status",compile:'<md-button class="md-raised md-primary panel-icon rank high-rank" aria-label="data control" ng-if="$parent.$parent.row.status===\'未审核\'">未审核</md-button><md-button class="md-raised md-primary panel-icon low-rank rank" aria-label="data control" ng-if="$parent.$parent.row.status===\'已审核\'">已审核</md-button>',style:{"text-align":"center",width:"160px"}},{text:"类型",name:"apply_status",style:{"text-align":"center",width:"160px"}}]);$scope.catList=[{cat_id:"",cat_name:"全部类型"}],$scope.staList=[{sta_id:void 0,sta_name:"全部状态"},{sta_id:"1",sta_name:"已审核"},{sta_id:"0",sta_name:"未审核"}],$scope.searcherApi=function(index,size){return getApiListQ=getApiList(index,size)},$scope.getCheckedApi=function(){return Array.isArray($scope.apiList)?$scope.apiList.filter(function(api){return api._checked}):[]},$scope.deleteApi=function(){if(0!==$scope.getCheckedApi().length)return $rootScope.confirm("确定要删除这些API吗？",function(){$scope.refreshing=!0;var api_id_list=$scope.getCheckedApi().map(function(api){return{api_id:api.api_id}});return $scope.ajax("delete_api",{api_id_list:api_id_list,app_id:$scope.appList._select&&$scope.appList._select.app_id}).then(function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?$scope.researchApi():$rootScope.alert(data.msg)})["finally"](function(){$scope.refreshing=!1})})},$scope.applyApi=function(){if(0!==$scope.getCheckedApi().length)return $rootScope.confirm("确定要申请这些API吗？",function(){$scope.refreshing=!0;var api_id_list=$scope.getCheckedApi().map(function(api){return{api_id:api.api_id}});return $scope.ajax("apply_api",{api_id_list:api_id_list,app_id:$scope.appList._select&&$scope.appList._select.app_id,cat_id:$scope.currentCat&&$scope.currentCat.cat_id}).then(function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?$scope.researchApi():$rootScope.alert(data.msg)})["finally"](function(){$scope.refreshing=!1})})},$scope.researchApi=function(){$scope.pageIndexApi=1,$scope.pageSizeApi=new Number(10)},$scope.selectCat=function(cat){$scope.currentCat=cat,$scope.researchApi()},$scope.selectSta=function(sta){$scope.currentSta=sta,$scope.researchApi()},$scope.resetCount=function(){$scope.refreshing||("1"===$scope.hasApplied?$scope.columnsApi=columnApplied:$scope.columnsApi=columnNoApplied,$scope.pageIndexApi=1,$scope.pageSizeApi=new Number(10))},$scope.checkApp=function(app){$scope.mode=2,$scope.refreshing0=!1,$scope.refreshing1=!1,$scope.refreshing2=!1,$scope.refreshing3=!1,$scope.appInfo=app},$scope.resetApp=function(type){if($scope.appInfo){var str="App Secret",prefix="1"==type?"App Secret重置后，沙箱环境中使用该应用帐号调用API的程序配置需要同步修改。":"0"==type?"App Secret重置后，生产环境中使用该应用帐号调用API的程序配置需要同步修改。":"";return"2"!=type&&"3"!=type||(str="Access Token"),$rootScope.confirm(prefix+"确定要重置"+str+"吗？",function(){var url="";switch(type){case"0":url="reset_prod_secret",$scope.refreshing0=!0;break;case"1":url="reset_dev_secret",$scope.refreshing1=!0;break;case"2":url="reset_prod_token",$scope.refreshing2=!0;break;case"3":url="reset_dev_token",$scope.refreshing3=!0;break;default:url=""}return $scope.refreshing=!0,$http.post("/agent",{module:"dashboard",partial:"applist",api:url,param:{app_id:$scope.appInfo.app_id}}).then(function(body){if("boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success){switch(type){case"0":$scope.appInfo.appsecret=body.data.appsecret;break;case"1":$scope.appInfo.test_appsecret=body.data.test_appsecret;break;case"2":$scope.appInfo.access_token=body.data.access_token,$scope.appInfo.expiring_time=body.data.expiring_time;break;case"3":$scope.appInfo.test_access_token=body.data.test_access_token,$scope.appInfo.test_expiring_time=body.data.test_expiring_time;break;default:url=""}return body.data}},function(why){return $q.reject(why)})["finally"](function(){switch($scope.refreshing=!1,type){case"0":$scope.refreshing0=!1;break;case"1":$scope.refreshing1=!1;break;case"2":$scope.refreshing2=!1;break;case"3":$scope.refreshing3=!1;break;default:url=""}})})}},$scope.createApp=function(event){showAppDialog(event,{})},$scope.copyApp=function(event,fromApp){showAppDialog(event,{},fromApp)},$scope.deleteApp=function(event){if($scope.appList._select&&$scope.appList._select)return"已审核"===$scope.appList._select.status&&$rootScope.alert("不可删除已审核应用！"),$rootScope.confirm("确定要删除该应用？",function(){return $scope.refreshing=!0,$scope.ajax("delete_app",{app_id:$scope.appList._select&&$scope.appList._select.app_id}).then(function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?$scope.research():$rootScope.alert(data.msg)})["finally"](function(){$scope.refreshing=!1})})},$scope.editApp=function(event,app){var currentApp={app_id:app.app_id,app_name:app.app_name,remark:app.remark};showAppDialog(event,currentApp)};var CreateAppCtrl=function(scope,app,fromApp){scope.app=app,scope.fromApp=fromApp,scope.save=function(){if(!scope.refreshing)return scope.appForm.$invalid?(scope.appForm.$error.required&&scope.appForm.$error.required.forEach(function(r){r.$setDirty(!0)}),scope.appForm.$error.maxlength&&scope.appForm.$error.maxlength.forEach(function(r){r.$setDirty(!0)}),void(scope.error="请检查输入是否正确")):(scope.refreshing=!0,$http.post("/agent",{module:"dashboard",partial:"applist",api:"create_api",param:{login_user_type:$rootScope.profile&&$rootScope.profile.login_user_type,app_id:scope.app.app_id,app_name:scope.app.app_name,remark:scope.app.remark,copy_app_id:scope.fromApp?scope.fromApp.app_id:void 0}}).then(function(body){return"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?(scope.close(),scope.app.app_id?$scope.searcher():$scope.research(),body.data):void(scope.error=body.data.msg)},function(why){return scope.error=why,$q.reject(why)})["finally"](function(){scope.refreshing=!1}))},scope.close=function(){$mdDialog.hide()}};window.test=$scope,$scope.$watch(function(){return $scope.mode},function(mode){mode?$rootScope.globalBack=globalBack:$rootScope.globalBack=null});var globalBack=function(){$scope.refreshing||$scope.refreshing0||$scope.refreshing1||$scope.refreshing2||$scope.refreshing3||$scope.loading||$scope.back()};$scope.$on("$destroy",function(event){$rootScope.globalBack=null})}]});