"use strict";define(["../../services"],function(){return["$rootScope","$scope","$q","$http","$mdDialog","$location",function($rootScope,$scope,$q,$http,$mdDialog,$location){function showSubuser(ev,subuser){$mdDialog.show({controller:EditSubuserCtrl,template:'\n          <md-dialog aria-label="{{!subuser.sub_user_id?\'添加子账号\':\'修改子账号\'}}" class="form" aria-describedby="quick edit" style="max-height: initial;">\n            <md-toolbar>\n              <div class="md-toolbar-tools">\n                <md-icon md-svg-icon="navigation:ic_apps_24px"></md-icon>\n                <h3><span ng-bind="!subuser.sub_user_id?\'添加子账号\':\'修改子账号\'"></span></h3>\n                <md-button class="md-icon-button md-primary md-hue-1" aria-label="Settings" ng-click="close()">\n                  <md-icon md-svg-icon="content:ic_clear_24px"></md-icon>\n                </md-button>\n              </div>\n            </md-toolbar>\n            <md-dialog-content>\n              <form class="md-dialog-content postfix-input" name="subuserForm" autocomplete="off">\n                <div class="input-container">\n                  <label>用户账号*</label>\n                  <input type="text" name="name" spellcheck="false" ng-model="subuser.user_account"  style="text-align: left;" required maxlength="25" unicode-length-validator/>\n                </div>\n                <div class="input-container">\n                  <label>用户密码{{subuser.sub_user_id ? \'\' : \'*\'}}</label>\n                  <input type="text" name="name" spellcheck="false" ng-model="subuser.password"  style="text-align: left;" ng-required="!subuser.sub_user_id" minlength="6" maxlength="25" unicode-length-validator/>\n                </div>\n                <div class="input-container">\n                  <label>用户昵称*</label>\n                  <input type="text" name="name" maxlength="15" spellcheck="false" ng-model="subuser.user_name"  style="text-align: left;" required />\n                </div>\n                <div class="input-container">\n                  <label>用户公司*</label>\n                  <input type="text" name="name" maxlength="100" spellcheck="false" ng-model="subuser.company"  style="text-align: left;" required unicode-length-validator/>\n                </div>\n                <div class="input-container">\n                  <label>用户部门</label>\n                  <input type="text" name="name" maxlength="100" spellcheck="false" ng-model="subuser.department"  style="text-align: left;" unicode-length-validator/>\n                </div>\n                <div class="input-container">\n                  <label>用户电话</label>\n                  <input type="text" name="name" maxlength="25" spellcheck="false" ng-model="subuser.tel" ng-pattern="\'([0-9]*-{0,1}[0-9]*)\'" style="text-align: left;" unicode-length-validator/>\n                </div>\n                <div class="input-container">\n                  <label>用户手机</label>\n                  <input type="text" name="name" maxlength="25" spellcheck="false" ng-model="subuser.mobile" ng-pattern="\'([0-9]*)\'" style="text-align: left;" unicode-length-validator/>\n                </div>\n                <div class="input-container">\n                  <label>用户邮箱</label>\n                  <input type="email" name="name" maxlength="500" spellcheck="false" ng-model="subuser.email"  style="text-align: left;"  unicode-length-validator/>\n                </div>\n                <div class="input-container">\n                  <label>用户QQ</label>\n                  <input type="text" name="name" maxlength="25" spellcheck="false" ng-pattern="\'([0-9]*)\'" ng-model="subuser.qq"  style="text-align: left;" unicode-length-validator/>\n                </div>\n                <md-input-container class="md-block">\n                  <label>备注</label>\n                  <textarea ng-model="subuser.remark" md-maxlength="100" rows="3" md-select-on-focus style="overflow: auto"></textarea>\n                </md-input-container>\n                <div class="hint" ng-if="!subuser.sub_user_id" aria-hidden="false" style="font-size: 12px;\n                    line-height: 14px;height: 28px;\n                    transition: all .3s cubic-bezier(0.55,0,0.55,0.2);\n                    color: rgba(0,0,0,0.38);">设置子账号信息后，您需要维护子账号的“权限设置”与“数据权限”。\n子账号登录时，登录规则为“主账号登录名称:子账号用户名称”，例如：“ruixue_isv:laurence”。\n                </div>\n              </form>\n              <div class="app-loading" ng-if="refreshing">\n                <md-progress-circular md-mode="indeterminate"></md-progress-circular>\n              </div>\n            </md-dialog-content>\n            <md-dialog-actions layout="row">\n              <div class="message" ng-if="error">\n                <span ng-bind="error"></span>\n              </div>\n              <md-button ng-click="save()" type="submit">保存</md-button>\n            </md-dialog-actions>\n          </md-dialog>\n          ',parent:angular.element("body>section>md-content"),targetEvent:ev,clickOutsideToClose:!0,locals:{subuser:subuser}})}$scope.columns=[{text:"用户账号",name:"user_account",style:{width:"160px","text-align":"center"}},{text:"用户昵称",name:"user_name",style:{width:"160px","text-align":"center"}},{text:"公司名称",name:"company",style:{width:"160px","text-align":"center"}},{text:"添加时间",name:"rx_insertTime",style:{width:"160px","text-align":"center"}}],$scope.mode=0,$scope.reset=function(){$scope.keyword="",$scope.tableData=[],$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.reset(),$scope.research=function(){$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.searcher=function(index,size){if(!$scope.loading){$scope.loading=!0;var previous=$scope.tableData&&$scope.tableData._select;return $rootScope.ajax("list",{pageindex:index||$scope.pageIndex,pagesize:size||$scope.pageSize,user_name:$scope.keyword}).then(function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?($scope.tableData=data.user_list,previous?$scope.tableData._select=[].concat.apply([],$scope.tableData.map(function(r){return previous.sub_user_id==r.sub_user_id?[r]:[]}))[0]:$scope.tableData._select=$scope.tableData[0],$scope.total=data.list_count):($rootScope.alert(data.msg),$scope.total=0)})["finally"](function(){$scope.loading=!1})}},$scope.deleteSubuser=function(){return $rootScope.confirm("确定要删除该账号？",function(){$scope.refreshing=!0,$rootScope.ajax("delete",{sub_user_id:$scope.tableData._select.sub_user_id}).then(function(data){("boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success)&&$scope.research()})["finally"](function(){$scope.refreshing=!1})})};var EditSubuserCtrl=function(scope,subuser){scope.subuser=subuser,scope.save=function(){if(!scope.refreshing)return scope.subuserForm.$invalid?(scope.subuserForm.$error.required&&scope.subuserForm.$error.required.forEach(function(r){r.$setDirty(!0)}),scope.subuserForm.$error.validUnicodeLength&&scope.subuserForm.$error.validUnicodeLength.forEach(function(r){r.$setDirty(!0)}),scope.subuserForm.$error.maxlength&&scope.subuserForm.$error.maxlength.forEach(function(r){r.$setDirty(!0)}),void(scope.error="请检查输入是否正确")):(scope.refreshing=!0,$http.post("/agent",{module:"dashboard",partial:$rootScope.tab.key,api:"save",param:{sub_user_id:scope.subuser.sub_user_id,user_account:scope.subuser.user_account,password:scope.subuser.password?scope.subuser.password:void 0,user_name:scope.subuser.user_name,company:scope.subuser.company,department:scope.subuser.department,tel:scope.subuser.tel,mobile:scope.subuser.mobile,email:scope.subuser.email,qq:scope.subuser.qq,remark:scope.subuser.remark}}).then(function(body){return"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?(scope.close(),void(scope.subuser&&scope.subuser.sub_user_id?$scope.searcher($scope.pageIndex,$scope.pageSize):$scope.reset())):(scope.error=body.data.msg,$q.reject(body.data.msg))},function(why){return scope.error=why,$q.reject(why)})["finally"](function(){scope.refreshing=!1}))},scope.close=function(){return $mdDialog.hide()}};$scope.showSubuser=function(ev,subuser){$scope.refreshing||(subuser?($scope.refreshing=!0,$rootScope.ajax("detail",{sub_user_id:subuser.sub_user_id}).then(function(data){("boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success)&&(subuser={sub_user_id:data.user_info.sub_user_id,user_account:data.user_info.user_account,password:data.user_info.password,user_name:data.user_info.user_name,company:data.user_info.company,department:data.user_info.department,tel:data.user_info.tel,mobile:data.user_info.mobile,email:data.user_info.email,qq:data.user_info.qq,remark:data.user_info.remark},showSubuser(ev,subuser))})["finally"](function(){$scope.refreshing=!1})):(subuser={user_account:"",password:"",user_name:"",company:"",department:"",tel:"",mobile:"",email:"",qq:"",remark:""},showSubuser(ev,subuser)))},$scope.showPermission=function(){!$scope.refreshing&&$scope.tableData._select&&($scope._checked=!1,$scope.permissionList=[],$scope._permission=null,$scope.mode=1,$scope.refreshing=!0,$rootScope.ajax("permission_get",{sub_user_id:$scope.tableData._select.sub_user_id}).then(function(data){("boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success)&&($scope.permissionList=data.func_list,Array.isArray($scope.permissionList)&&$scope.permissionList.length>0&&($scope._permission=$scope.permissionList[0]))})["finally"](function(){$scope.refreshing=!1}))},$scope.savePermission=function(){if(!$scope.refreshing&&$scope.tableData._select){$scope.refreshing=!0;var func_list=[];$scope.permissionList.forEach(function(per){"1"===per.checked&&func_list.push({func_id:per.func_id}),per.sub_func_list.forEach(function(sub){"1"===sub.checked&&func_list.push({func_id:sub.func_id}),sub.sub_func_role.forEach(function(role){"1"===role.checked&&func_list.push({func_id:role.func_id})})})}),$rootScope.ajax("permission_save",{sub_user_id:$scope.tableData._select.sub_user_id,func_list:func_list}).then(function(data){("boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success)&&$scope.backToFistStep()})["finally"](function(){$scope.refreshing=!1})}},$scope.backToFistStep=function(){$scope.mode=0,$scope.searcher()},$scope.checkPermission=function(permission){var value=permission.checked,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=permission.sub_func_list[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var subpermission=_step.value,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=subpermission.sub_func_role[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var role=_step2.value;role.checked=value}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2["return"]&&_iterator2["return"]()}finally{if(_didIteratorError2)throw _iteratorError2}}subpermission.checked=value}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator["return"]&&_iterator["return"]()}finally{if(_didIteratorError)throw _iteratorError}}},$scope.checkSubpermission=function(subpermission){var value=subpermission.checked,_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=subpermission.sub_func_role[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var role=_step3.value;role.checked=value}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3["return"]&&_iterator3["return"]()}finally{if(_didIteratorError3)throw _iteratorError3}}if("1"===value){var _iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=$scope.permissionList[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var permission=_step4.value;if(permission.sub_func_list.some(function(sub){return sub.func_id===subpermission.func_id})){permission.checked="1";break}}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4["return"]&&_iterator4["return"]()}finally{if(_didIteratorError4)throw _iteratorError4}}}},$scope.checkRole=function(role){if("1"===role.checked){var _iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=$scope.permissionList[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var permission=_step5.value,_subpermission=null,_iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _step6,_iterator6=permission.sub_func_list[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0){var subpermission=_step6.value;if(subpermission.sub_func_role.some(function(item){return item.func_id===role.func_id})){subpermission.checked="1",_subpermission=subpermission;break}}}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6["return"]&&_iterator6["return"]()}finally{if(_didIteratorError6)throw _iteratorError6}}if(_subpermission){permission.checked="1";break}}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5["return"]&&_iterator5["return"]()}finally{if(_didIteratorError5)throw _iteratorError5}}}},$scope.selectPermission=function(permission){$scope._permission=permission},$scope.showAppList=function(){!$scope.refreshing&&$scope.tableData._select&&($scope.appList=[],$scope.mode=2,$scope.refreshing=!0,$rootScope.ajax("app_get",{sub_user_id:$scope.tableData._select.sub_user_id}).then(function(data){("boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success)&&($scope.appList=data.data_list)})["finally"](function(){$scope.refreshing=!1}))},$scope.checkApp=function(){var value=$scope.appList._checked;$scope.appList.forEach(function(app){app.role_flag=value})},$scope.saveApp=function(){if(!$scope.refreshing&&$scope.tableData._select){$scope.refreshing=!0;var app_list=[];$scope.appList.forEach(function(app){"1"===app.role_flag&&app_list.push({app_id:app.app_id})}),$rootScope.ajax("app_save",{sub_user_id:$scope.tableData._select.sub_user_id,app_id_list:app_list}).then(function(data){("boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success)&&$scope.backToFistStep()})["finally"](function(){$scope.refreshing=!1})}},window.test=$scope,$scope.$watch(function(){return $scope.mode},function(mode){mode?$rootScope.globalBack=globalBack:$rootScope.globalBack=null});var globalBack=function(){$scope.refreshing||$scope.refreshingUser||$scope.refreshingProd||$scope.loading||$scope.backToFistStep()};$scope.$on("$destroy",function(event){$rootScope.globalBack=null})}]});