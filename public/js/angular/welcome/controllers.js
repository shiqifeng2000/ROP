"use strict";var controllerModule=angular.module("welcome.controllers",[]);controllerModule.config(["$provide","$logProvider","$compileProvider",function($provide,$logProvider,$compileProvider){$logProvider.debugEnabled(!1),$compileProvider.debugInfoEnabled(!1)}]).controller("IndexCtrl",["$rootScope","$scope","$http","$timeout","$window",function($rootScope,$scope,$http,$timeout,$window){$('a[href^="#"]',"#partials").click(function(e){e.preventDefault()}),$scope.news=[],$scope.showMeTitle=function(e){$(e.currentTarget).hasClass("animation");$(e.currentTarget).toggleClass("animation")};var swiperOpt={pagination:".swiper-pagination",autoplay:6e3,speed:800,slidesPerView:1,paginationClickable:!0,spaceBetween:30,keyboardControl:!0,effect:"fade",preloadImages:!1,onLazyImageReady:function(swiper,slide,image){},onProgress:function(swiper,progress){}};document.body.scrollTop=0,$(".transitionEndBubbleStop").off("transitionend"),$(".transitionEndBubbleStop").bind("transitionend",function(e){e.stopPropagation()}),$rootScope._toolbarFeature=0,window.test=$scope,$scope.$on("$viewContentLoaded",function(event){$rootScope.removeLoading()["finally"](function(){$scope.nextTick(function(){window.swiper=new Swiper(".swiper-container",swiperOpt)})})})}]).controller("SuppliersCtrl",["$rootScope","$scope","$http",function($rootScope,$scope,$http){$scope.items=[],$scope.ssvs=[],$scope.pageindex=1,$('a[href^="#"]',"#partials").click(function(e){e.preventDefault()}),$scope.load=function(){$scope.lock||($scope.lock=!0,$http.post("/agent",{module:"welcome",partial:"suppliers",api:"suppliers"}).then(function(body){if("boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success){$scope.items=body.data.data_list}else $rootScope.alert(body.data.msg);$scope.lock=!1},function(why){$rootScope.alert(why),$scope.lock=!1}))},$scope.toSsv=function(ssv){$scope.locate(Constant.protocol+"://"+ssv.user_domain+"."+Constant.host+":"+Constant.port)},$scope.isOdd=function(index){var isOdd=(index%6+Math.floor(index/6))%2;return isOdd},$scope.load(),$scope.$on("$viewContentLoaded",$rootScope.removeLoading)}]).controller("DocCtrl",["$rootScope","$scope","$http","$stateParams","$location","$q","$state",function($rootScope,$scope,$http,$stateParams,$location,$q,$state){var visitCounter=function(param){return $rootScope.ajax("view_count",param)},catQ=$q.when(),getCatQ=function(){return $scope.loading=!0,$rootScope.ajax("doc_cat",{}).then(function(body){$scope.rootTree=body.cat_list_level_1})["finally"](function(){$scope.loading=!1})},getDetailQ=function(doc_id){return $scope.refreshing?$q.reject():($scope.refreshing=!0,$scope.legacyDocument=null,$rootScope.ajax("doc_detail",{doc_id:doc_id}).then(function(data){var flag=!0;return catQ.then(function(){$scope.rootTree.every(function(trunk,i){return delete trunk._detail,!!flag&&(trunk.cat_list_level_2&&trunk.cat_list_level_2.length&&trunk.cat_list_level_2.every(function(branch,i){return delete branch._isOpen,trunk!==$scope.currentTrunk&&delete branch._detail,(branch?branch.doc_id.toLowerCase():"")==(doc_id?doc_id.toLowerCase():"")&&(branch._isOpen=!0,$scope.currentTrunk=trunk,branch._detail=data,flag=!1),!0}),!0)}),flag&&($scope.legacyDocument=data)}),visitCounter({doc_id:doc_id,set_type:0}),$scope.detail=data,data})["finally"](function(){$scope.refreshing=!1}))};$scope.locateAnchor=function(index){angular.element(".view-frame").animate({scrollTop:angular.element(".content-list")[index].offsetTop})},$scope.checkoutDoc=function(trunk,branch){if($scope.refreshing)return $q.reject();if($scope.loading)return $q.reject();var trueBranch=branch;trueBranch||(trueBranch=trunk.cat_list_level_2[0]),trueBranch.doc_id&&($scope.detailQ=$scope.getDetailQ(trueBranch.doc_id).then(function(data){$scope.detail=data,window.rxStream&&window.rxStream.track("rop_document_visit",{properties:{b_rop_document_name:data.doc_name||"未知页面"}}),$rootScope.go("document.details",{id:trueBranch.doc_id&&trueBranch.doc_id.toLowerCase()||""})}))},$scope.getDetailQ=getDetailQ,$scope.getCatQ=getCatQ,$scope.anchorIndex=0,$scope.reset=function(){$scope.docId="",$scope.detail=null,catQ.then(function(){$scope.rootTree.every(function(trunk,i){delete trunk._detail,trunk.cat_list_level_2&&trunk.cat_list_level_2.length&&trunk.cat_list_level_2.every(function(branch,i){delete branch._isOpen,delete branch._detail})})})},!$scope.rootTree&&(catQ=$scope.getCatQ()),"document.details"==$state.current.name&&($scope.detailQ=getDetailQ($state.params.id)),window.test=$scope,$scope.$on("$viewContentLoaded",function(event){$rootScope.removeLoading();var lastScrollTop,highlightIndex=0;angular.element(".view-frame").on("scroll",function(e){for(var list=angular.element(".content-list",e.currentTarget),viewHeight=window.innerHeight-177,i=list.length-1;i>=0;i--){var scrollTop=e.currentTarget.scrollTop,elem=list[i];elem.offsetTop>=scrollTop&&elem.offsetTop<=scrollTop+viewHeight&&(lastScrollTop<=scrollTop?(i==list.length-1||i!=list.length-1&&highlightIndex!=list.length-1)&&(highlightIndex=i):highlightIndex=i)}$scope.anchorIndex!=highlightIndex&&(e.currentTarget.scrollHeight-e.currentTarget.scrollTop==window.innerHeight?$scope.anchorIndex=list.length-1:$scope.anchorIndex=highlightIndex,$scope.$apply()),lastScrollTop=e.currentTarget.scrollTop})})}]).controller("DocDetailCtrl",["$rootScope","$scope","$stateParams","$timeout","$state","$q",function($rootScope,$scope,$stateParams,$timeout,$state,$q){var docId=$stateParams.id,detailQ=$scope.detailQ;$scope.detail&&$scope.detail.doc_id&&docId.toLowerCase()!=$scope.detail.doc_id.toLowerCase()&&($scope.$parent.detail={},detailQ=$scope.getDetailQ(docId)),$scope.imageresizer=function(element){angular.element("img",element).each(function(i,img){var $img=angular.element(img),naturalWidth=$img.attr("width"),naturalHeight=$img.attr("height");naturalWidth&&naturalHeight&&naturalWidth>=862&&$img.css({height:862*naturalHeight/naturalWidth})})},$scope.$parent.docId=docId,$scope.docUrl=Constant.protocol+"://"+Constant.host+"/welcome/document/"+docId,require(["clipboard"],function(Clipboard,inView){var _lang=$rootScope._lang,beforeClipboardCopy="zh-cn"==_lang?"复制文档地址":"Copy document URL",afterClipboardCopy="zh-cn"==_lang?"已复制":"Copied",workaroundSupportClipboard=function(action){var actionMsg=" 来"+("cut"===action?"剪切":"拷贝"),actionKey="cut"===action?"X":"C";return actionMsg=/iPhone|iPad/i.test(navigator.userAgent)?"暂不支持iPhone和iPad :(":/Mac/i.test(navigator.userAgent)?"请按 ⌘-"+actionKey+actionMsg:"请按 Ctrl-"+actionKey+actionMsg},cliper=new Clipboard(".cliper");$scope.clipboardHints=beforeClipboardCopy,$scope.locator=function(e,hash){e.preventDefault(),e.stopPropagation();var currentScrollTop=$(".view-frame.doc .sub-frame")[0].scrollTop;$(".view-frame.doc .sub-frame").animate({scrollTop:currentScrollTop+$(hash).offset().top-64})},detailQ.then(function(){cliper.on("success",function(e){e.clearSelection(),$scope.clipboardHints=afterClipboardCopy,$scope.$apply(),$timeout(function(){$scope.clipboardHints=beforeClipboardCopy},5e3)}),cliper.on("error",function(e){$scope.clipboardHints=workaroundSupportClipboard(e.action),$scope.$apply(),$timeout(function(){$scope.clipboardHints=beforeClipboardCopy},5e3)})}),window.test1=$scope,$scope.$on("$destroy",function(){cliper&&cliper.destroy(),"document.details"!=$state.current.name&&$scope.reset()})}),$scope.$on("$viewContentLoaded",function(event){document.querySelector(".view-frame").scrollTop=0,$rootScope.removeLoading()})}]).controller("FeaturesCtrl",["$rootScope","$scope","$http","$state",function($rootScope,$scope,$http,$state){$('a[href^="#"]',"#partials").click(function(e){e.preventDefault()}),$scope.$on("$viewContentLoaded",$rootScope.removeLoading)}]).controller("ServicesCtrl",["$rootScope","$scope","$http","$mdDialog","$mdSidenav","$window",function($rootScope,$scope,$http,$mdDialog,$mdSidenav,$window){$('a[href^="#"]',"#partials").click(function(e){e.preventDefault()});$http.post("/agent",{module:"welcome",partial:"services",api:"notice",param:{}}).then(function(body){body.data.data_list&&body.data.data_list.length&&($scope.notice_list=body.data.data_list)},function(why){$rootScope.alert(why)}),$http.post("/agent",{module:"welcome",partial:"services",api:"faq",param:{}}).then(function(body){body.data.data_list&&body.data.data_list.length&&($scope.faqs=body.data.data_list)},function(why){$rootScope.alert(why)});$scope.toggleSidenav=function(){return $mdSidenav("right").toggle()},$scope.askQuestion=function(e){return $scope.qaForm.$invalid?($mdDialog.show($mdDialog.alert().title("提示").textContent("请核对提交表单是否正确").ariaLabel("提交失败").ok("好的").targetEvent(e)),void($scope.qaForm.$error.required&&$scope.qaForm.$error.required.forEach(function(r){r.$setDirty(!0)}))):(e.preventDefault(),$http.post("/agent",{module:"welcome",partial:"services",api:"askQuestion",param:$scope.question}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($mdDialog.show($mdDialog.alert().title("提交成功").textContent("我们收到了您的问题，会尽快回答，请次日登录帮助中心查看我们的回复.").ariaLabel("提交成功").ok("好的").targetEvent(e)),$mdSidenav("right").close()):$mdDialog.show($mdDialog.alert().title("提交失败").textContent(body.data.msg).ariaLabel("提交失败").ok("好的").targetEvent(e))},function(why){$rootScope.alert(why)}))},$scope.$on("$viewContentLoaded",$rootScope.removeLoading)}]).controller("SearchCtrl",["$rootScope","$scope","$http",function($rootScope,$scope,$http){$scope.searchCategory="all",$scope.hints=[],$scope.pageIndex=1,$scope.pageSize=new Number(10);var initial=!0;$scope.searcher=function(index,size){if(initial)return void(initial=!1);var keyword=$("#bloodhound").val();window.rxStream&&window.rxStream.track("search_key",{properties:{b_key:keyword,b_category:$scope.searchCategory}}),$http.post("/agent",{module:"welcome",partial:"search",api:"search",param:{pageindex:index||$scope.pageIndex,pagesize:size||$scope.pageSize,searchflg:$scope.searchCategory,keyword:keyword}}).then(function(body){$scope.response=body.data.response,body.data.response&&body.data.response.docs&&body.data.response.docs.length?"all"==$scope.searchCategory?$scope.total=body.data.response.numFound:"api"==$scope.searchCategory?$scope.total=body.data.response.numFoundApi:"doc"==$scope.searchCategory?$scope.total=body.data.response.numFoundDoc:"sdk"==$scope.searchCategory?$scope.total=body.data.response.numFoundSdk:"tool"==$scope.searchCategory?$scope.total=body.data.response.numFoundTool:"other"==$scope.searchCategory?$scope.total=body.data.response.numFoundOther:$scope.total=0:$scope.total=0,setTimeout(function(){$(window).trigger("scroll")},100)},function(why){$rootScope.alert(why),$scope.total=0})},$http.post("/agent",{module:"welcome",partial:"search",api:"hints"}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.rawHints=body.data.hint_list,require(["bloodhound","typeahead"],function(){var keyword=new Bloodhound({datumTokenizer:function(str){return str?str.split(""):[]},queryTokenizer:function(str){return str?str.split(""):[]},sorter:function(itemA,itemB){return itemA.indexOf($scope.keyword)>itemB.indexOf($scope.keyword)?-1:itemA.indexOf($scope.keyword)<itemB.indexOf($scope.keyword)?1:0},local:$scope.rawHints.map(function(r){return r.title})});$(".typeahead").typeahead({hint:!0,highlight:!0,minLength:1},{name:"keyword",source:keyword,limit:10}).on("typeahead:selected",function(event,selection){$scope.research($scope.searchCategory),$scope.$digest()})})):$rootScope.warn(body.data.msg)},function(why){$rootScope.alert(why)}),$scope.research=function(cat,key){$scope.hints=[],$scope.searchCategory=cat,$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.$on("$viewContentLoaded",$rootScope.removeLoading)}]).controller("DebugToolCtrl",["$rootScope","$scope","$http","$stateParams","$location",function($rootScope,$scope,$http,$stateParams,$location){var key=$stateParams.key?$stateParams.key:$location.search().key;$("#mainFrame").attr("src","/frame/ApiTool/index"+(key?"?sign="+key:"")),$('a[href^="#"]',"#partials").click(function(e){e.preventDefault()}),$scope.$on("$viewContentLoaded",function(event){window._messageListener=function(event){event.origin==Constant.legacyDomain&&$("iframe").height(event.data+20)},window.addEventListener("message",window._messageListener),$rootScope.removeLoading()})}]).controller("SDKToolCtrl",["$rootScope","$scope","$http","$stateParams",function($rootScope,$scope,$http,$stateParams){$scope.sdks=[{logo:"/resource/logo-dotnet.png",bg:"#33B5E5"},{logo:"/resource/logo-java.png",bg:"#AA66CC"},{logo:"/resource/logo-php.png",bg:"#00CC99"},{logo:"/resource/logo-js.png",bg:"#FFBB33"},{logo:"/resource/logo-android.png",bg:"#FF4444"}],$('a[href^="#"]',"#partials").click(function(e){e.preventDefault()});$http.post("/agent",{module:"welcome",partial:"sdktool",api:"list",param:{sdk_type:1}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?$scope.sdk=body.data.sdk:$rootScope.warn(body.data.msg)},function(why){$rootScope.alert(why)});$scope.$on("$viewContentLoaded",$rootScope.removeLoading)}]).controller("APICtrl",["$rootScope","$scope","$http","$state",function($rootScope,$scope,$http,$state){var catQ=function(){return $http.post("/agent",{module:"welcome",partial:"api",api:"list"}).then(function(body){if($scope.originalCat={cat_list:body.data.cat_list,_selectedItem:0},body.data&&body.data.cat_list&&body.data.cat_list.length){if($scope.cat={cat_list:body.data.cat_list,_selectedItem:0},$scope.cat.cat_list)for(var j=0;j<$scope.cat.cat_list.length;j++)if($scope.cat.cat_list[j].group_list){$scope.cat.cat_list[j]._selectedItem=0;for(var i=0;i<$scope.cat.cat_list[j].group_list.length;i++)if($scope.cat.cat_list[j].group_list[i].api_list)for(var k=0;k<$scope.cat.cat_list[j].group_list[i].api_list.length;k++);}}else $scope.cat={cat_list:body.data.cat_list,_selectedItem:0},$rootScope.alert("当前供应商没有任何API发布")},function(why){$rootScope.alert(why)})};$scope.changeAPISearch=function(){var cat=JSON.parse(JSON.stringify($scope.originalCat));if(cat._selectedItem=$scope.cat._selectedItem,cat.cat_list)for(var j=0;j<cat.cat_list.length;j++)if(cat.cat_list[j]._selectedItem=$scope.cat.cat_list[j]._selectedItem,cat.cat_list[j].group_list)for(var i=0;i<cat.cat_list[j].group_list.length;i++)if(cat.cat_list[j].group_list[i].api_list)for(var k=cat.cat_list[j].group_list[i].api_list.length;k--;)cat.cat_list[j].group_list[i].api_list[k].api_name.indexOf($scope.apiSearch)==-1&&cat.cat_list[j].group_list[i].api_list[k].api_title.indexOf($scope.apiSearch)==-1&&cat.cat_list[j].group_list[i].api_list.splice(k,1);$scope.cat=cat},catQ(),$scope.apiMethod=function(api){return Constant.protocol+"://"+Constant.host+"/api/ApiMethod-"+api.api_id+".html"},$scope.$on("$viewContentLoaded",$rootScope.removeLoading)}]);