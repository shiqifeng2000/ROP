"use strict";angular.module("rop.directives",["ngMaterial"]).directive("ropTreeView",["$compile",function($compile){return{restrict:"AE",scope:{data:"=data",field:"=field",option:"=option"},replace:!0,templateUrl:"/js/angular/template/tree_view.html",link:function($scope,element,attrs){try{$scope.data=JSON.parse(attrs.data)}catch(e){$scope.data=$scope.$parent[attrs.data]}var recur=function recur(item,runner){item[$scope.field.children]&&item[$scope.field.children].length&&item[$scope.field.children].forEach(function(subItem){runner(subItem,item),recur(subItem,runner)})},recur_counter=function recur_counter(item,checked){var allUnchecked=!0;item[$scope.field.children]&&item[$scope.field.children].forEach(function(brother){checked?!brother[$scope.field.checked]&&(allUnchecked=!1):brother[$scope.field.checked]&&(allUnchecked=!1)}),allUnchecked&&(item[$scope.field.checked]=checked,item._parent&&recur_counter(item._parent,checked))},watcher=function(){!$scope.option&&($scope.option={}),$scope.field&&(!$scope.field.id&&($scope.field.id="_id"),!$scope.field.label&&($scope.field.id="_label"),!$scope.field.children&&($scope.field.children="_children"),!$scope.field.checked&&($scope.field.checked="_checked"),!$scope.field.collapsed&&($scope.field.collapsed="_collapsed")),$scope.data&&$scope.data.forEach(function(item){item[$scope.field.children]&&item[$scope.field.children].length&&($scope.option.collapseAll?item[$scope.field.collapsed]=!0:item[$scope.field.collapsed]=!1),recur(item,function(node,parent){node._parent=parent,node[$scope.field.children]&&node[$scope.field.children].length&&($scope.option.collapseAll?node[$scope.field.collapsed]=!0:node[$scope.field.collapsed]=!1)})})};$scope.$watch("data",function(){watcher()}),$scope.$parent.RopTreeView={},$scope.$parent.RopTreeView.getChecked=function(){var list=[];return $scope.data&&$scope.data.forEach(function(item){item[$scope.field.checked]&&list.push(item),recur(item,function(node){node[$scope.field.checked]&&list.push(node)})}),list},$scope.toggleChecked=function(item){item[$scope.field.checked]=!item[$scope.field.checked],recur(item,function(node){node[$scope.field.checked]=item[$scope.field.checked]}),item[$scope.field.checked]?item._parent&&(item._parent[$scope.field.checked]=item[$scope.field.checked],item._parent._parent&&(item._parent._parent[$scope.field.checked]=item[$scope.field.checked])):item._parent&&recur_counter(item._parent,!1)},$scope.toggleCollapse=function(item){item[$scope.field.collapsed]=!item[$scope.field.collapsed]}}}}]).directive("strboolean",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){ngModel.$formatters.push(function(value){return void 0===value?void 0:value?"1":"0"}),ngModel.$parsers.push(function(value){return void 0===value?void 0:value?"1":"0"})}}}).directive("charRestriction",[function(){return{restrict:"A",scope:{charcodes:"=charcodes"},link:function(scope,element,attrs){scope.charcodes&&scope.charcodes.length&&angular.element(element).on("keydown",function(e){return!("ArrowLeft"!=e.key&&"ArrowRight"!=e.key&&"Shift"!=e.key&&"Control"!=e.key&&"Alt"!=e.key&&"Meta"!=e.key&&"Backspace"!=e.key&&"Forward"!=e.key&&"Delete"!=e.key&&scope.charcodes.indexOf(e.keyCode)<0)||(e.preventDefault(),!1)})}}}]).directive("xmlValidator",function(){return{require:"ngModel",link:function(scope,element,attributes,ngModel){ngModel.$validators.xmlValidator=function(modelValue){var xml,tmp;try{window.DOMParser?(tmp=new DOMParser,xml=tmp.parseFromString(modelValue,"text/xml")):(xml=new ActiveXObject("Microsoft.XMLDOM"),xml.async="false",xml.loadXML(modelValue))}catch(e){xml=void 0}return!(!xml||!xml.documentElement||xml.getElementsByTagName("parsererror").length)}}}}).directive("jsonValidator",function(){return{require:"ngModel",link:function(scope,element,attributes,ngModel){ngModel.$validators.jsonValidator=function(modelValue){var result=!0;try{JSON.parse(modelValue)}catch(e){result=!1}return result}}}}).directive("ropDatatable",["$parse","$timeout",function($parse,$timeout){return{restrict:"AE",scope:{cols:"=cols",sorter:"=sorter",data:"=data",index:"=index",size:"=size",total:"=total",searcher:"=searcher",infinite:"@infinite",multiSelection:"=multiple",noSelection:"=noselection",key:"=key"},templateUrl:"/_template/datatable",link:function($scope,element,attrs){$scope.checkAll=function(){$scope.allChecked?($scope.data.forEach(function(r){!r._locked&&(r._checked=!1)}),$scope.allChecked=!1):($scope.data.forEach(function(r){!r._locked&&(r._checked=!0)}),$scope.allChecked=!0)},$scope.sort=function(col){col.sort="1"==col.sort?"0":"1",$scope.cols.forEach(function(r,i){r!==col&&(r.sort=r.sort?"1":void 0)});for(var prop in col)$scope.sorter[prop]=col[prop];$scope.index=1,$scope.size=new Number($scope.size)},$scope.verifyCheckAll=function(){var result=!0;if($scope.data)if(0==$scope.data.length)result=!1;else for(var i=0;i<$scope.data.length;i++){var r=$scope.data[i];!r._locked&&!r._checked&&(result=!1),r._locked&&(result=!1)}result?$scope.allChecked=!0:$scope.allChecked=!1},$scope.$watch("data",function(newList,oldList){if($scope.verifyCheckAll(),$scope.key&&newList&&newList.length&&oldList._select)for(var j=0;j<newList.length;j++){var newRow=newList[j];newRow[$scope.key]==oldList._select[$scope.key]&&(newList._select=newRow)}})}}}]).directive("ropFixedTable",["$parse","$timeout",function($parse,$timeout){return{restrict:"AE",scope:{cols:"=cols",data:"=data",cursor:"=cursor",keyword:"=keyword",multiSelection:"=multiple",noSelection:"=noselection",noRowSelection:"=norowselection",lineHeight:"@lineHeight",scrollerStyle:"=scrollerstyle",key:"=key"},templateUrl:"/_template/fixed_table",link:function($scope,element,attrs){$scope.checkAll=function(){$scope.allChecked?($scope.data.forEach(function(r){!r._locked&&(r._checked=!1)}),$scope.allChecked=!1):($scope.data.forEach(function(r){!r._locked&&(r._checked=!0)}),$scope.allChecked=!0)},$scope.verifyCheckAll=function(){var result=!0;if($scope.data)if(0==$scope.data.length)result=!1;else for(var i=0;i<$scope.data.length;i++){var r=$scope.data[i];!r._locked&&!r._checked&&(result=!1),r._locked&&(result=!1)}result?$scope.allChecked=!0:$scope.allChecked=!1},$scope.$watch("data",function(){if($scope.verifyCheckAll(),$scope.key&&newList&&newList.length&&oldList._select)for(var j=0;j<newList.length;j++){var newRow=newList[j];newRow[$scope.key]==oldList._select[$scope.key]&&(newList._select=newRow)}}),$scope.$watch(function(){return $scope.cursor},function(a){var $el=element.find(".scroller");$el.animate({scrollTop:($scope.lineHeight||40)*$scope.cursor})})}}}]).directive("ropPagination",["$parse","$mdUtil",function($parse,$mdUtil){return{restrict:"A",scope:{index:"=index",size:"=size",total:"=total",searcher:"=searcher",infinite:"=infinite",infiniteEnd:"=infiniteEnd"},templateUrl:"/_template/pagination",link:function($scope,element,attrs){$scope.myIndex=1,"number"==typeof $scope.index&&($scope.ceilingIndex=$scope.index+4),$scope.initialLinking=void 0===$scope.total;var recalcPages=function(){var total="string"==typeof $scope.total?Number($scope.total):$scope.total,length=$scope.pages&&$scope.pages.length?$scope.pages.length:0;if(Math.ceil(total/$scope.size)>length)for(var i=Math.ceil(total/$scope.size)-1;i>=0;i--)$scope.pages[i]||($scope.pages[i]={index:i+1});else for(var _i=length-1;_i>Math.ceil(total/$scope.size)-1;_i--)$scope.pages[_i]&&$scope.pages.pop();$scope.ceilingIndex=Math.max(Math.min($scope.index+4,$scope.pages.length),5)};$scope.$watch("total",function(value,newValue){$scope.total&&($scope.pages&&$scope.pages.length||($scope.pages=$scope.pages||[],recalcPages()))}),$scope.$watch("size",function(value,newValue){if($scope.size){!$scope.pages&&($scope.pages=[]),$scope.initialLinking&&($scope.index=1,$scope.myIndex=1);var promise=$scope.searcher($scope.index,$scope.size);promise&&promise.then?promise.then(function(body){return $mdUtil.nextTick(recalcPages),body}):recalcPages()}}),$scope.toFirst=function(){$scope.index=1,$scope.ceilingIndex=5,$scope.searcher($scope.index,$scope.size)},$scope.toLast=function(){$scope.pages&&$scope.pages.length>0?($scope.index=$scope.pages.length,$scope.ceilingIndex=$scope.pages.length):($scope.index=1,$scope.ceilingIndex=1),$scope.searcher($scope.index,$scope.size)},$scope.searchPrevious=function(){$scope.ceilingIndex==$scope.index+4&&$scope.index>1&&$scope.ceilingIndex--,$scope.index>1&&(--$scope.index,$scope.searcher($scope.index,$scope.size))},$scope.searchNext=function(){$scope.ceilingIndex==$scope.index&&$scope.index<$scope.pages.length&&$scope.ceilingIndex++,($scope.infinite||$scope.index<$scope.pages.length)&&(++$scope.index,$scope.searcher($scope.index,$scope.size))},$scope.searchIndex=function(i){$scope.index="string"==typeof i?Number(i):i,$scope.searcher($scope.index,$scope.size)},$scope.toPage=function(){var myIndex="string"==typeof $scope.myIndex?Number($scope.myIndex):$scope.myIndex;isNaN(myIndex)||myIndex>$scope.pages.length||myIndex<=0||($scope.ceilingIndex=Math.max(Math.min(myIndex+4,$scope.pages.length),5),$scope.searchIndex(myIndex))},$scope.infinite&&($scope.infiniteStart=function(){return 1==$scope.index})}}}]).directive("ropStepper",["$parse","$timeout",function($parse,$timeout){return{restrict:"AE",scope:{index:"=index",steps:"=steps"},replace:!0,templateUrl:"/_template/stepper",link:function($scope,element,attrs){}}}]).directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(scope,element,attributes,ngModel){ngModel.$validators.compareTo=function(modelValue){return modelValue==scope.otherModelValue},scope.$watch("otherModelValue",function(){ngModel.$validate()})}}}).directive("customValidate",function(){return{require:"ngModel",scope:{customValidate:"=customValidate"},link:function(scope,element,attributes,ngModel){ngModel.$validators.customValidate=scope.customValidate||void 0,scope.$watch("otherModelValue",function(){ngModel.$validate()})}}}).directive("captchaValidator",["$cookies",function($cookies){return{restrict:"A",require:"ngModel",scope:{captchaValue:"=captchaValidator"},link:function(scope,element,attributes,ngModel){ngModel.$validators.validCaptcha=function(modelValue){return(modelValue?modelValue.toLowerCase():"")==($cookies.get("_captcha")?$cookies.get("_captcha").toLowerCase():"")},scope.$watch("captchaValue",function(){ngModel.$validate()})}}}]).directive("unicodeLengthValidator",[function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attributes,ngModel){var maxlength=attributes.maxlength;"number"!=typeof maxlength&&(maxlength=Number(maxlength)),ngModel.$validators.validUnicodeLength=function(modelValue){var result=0;if(modelValue){var urilength=encodeURIComponent(modelValue).match(/%[89ABab]/g);result=urilength?modelValue.length+Math.floor(urilength.length/2):modelValue.getBytesLength()}return(isNaN(maxlength)?0:maxlength)>=result}}}}]).directive("contentSelection",["$timeout",function($timeout){return{restrict:"A",scope:{keyword:"=keyword"},link:function(scope,element,attrs){scope.$watch("keyword",function(){if(scope.keyword){var value=element.val(),start=value.indexOf(scope.keyword),end=value.indexOf(scope.keyword)+scope.keyword.length;element[0].setSelectionRange(start,end),element.focus()}})}}}]).directive("compile",["$compile","$mdUtil",function($compile,$mdUtil){return{restrict:"AE",scope:{content:"=content",imageresizer:"=imageresizer"},link:function(scope,element,attrs){scope.$watch("content",function(value){value&&(element.html(value),$compile(element.contents())(scope),scope.imageresizer&&"function"==typeof scope.imageresizer&&scope.imageresizer(element))})}}}]).directive("blurUp",["$timeout",function($timeout){return{restrict:"AE",scope:{source:"@"},link:function(scope,element,attrs){$timeout(function(){element.css("backgroundImage","url("+scope.source+"?blur=true)"),angular.element("<img/>").attr("src",""+scope.source).on("load",function(e){element.css("backgroundImage","url("+scope.source+")"),angular.element(e.currentTarget).remove()})})}}}]);