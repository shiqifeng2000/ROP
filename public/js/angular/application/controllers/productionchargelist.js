"use strict";define(["../../services"],function(cta){return["$rootScope","$scope","$q","$http","$mdDialog","$location",function($rootScope,$scope,$q,$http,$mdDialog,$location){function initFunction(){return $scope.loading=!0,$scope.ajax("charge_init").then(function(data){$scope.userList=[{user_id:"",user_name:"全部用户"}].concat(data.user_list),$scope.currentUser=$scope.userList[0],$scope.prodList=[{product_id:"",product_name:"全部产品"}].concat(data.product_list),$scope.currentProd=$scope.prodList[0]})["finally"](function(){$scope.loading=!1})}function initChargeUser(){if(!$scope.refreshingUser)return $scope.refreshingUser=!0,$scope.ajax("charge_detail_user_init").then(function(data){("boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success)&&($scope.chargeUserData=data.user_list,$scope.chargeUserList=data.user_list,$scope.chargeUserList.length>0?$scope.chargeUserList._select=$scope.chargeUserList[0]:$scope.chargeUserList._select={})})["finally"](function(){$scope.refreshingUser=!1})}function initChargeProd(){if(!$scope.refreshingProd)return $scope.refreshingProd=!0,$scope.ajax("charge_detail_production_init").then(function(data){("boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success)&&($scope.chargeProdData=data.data_list,$scope.chargeProdList=data.data_list)})["finally"](function(){$scope.refreshingProd=!1})}var initQ=void 0,initChargeUserQ=void 0,initChargeProdQ=void 0;$scope.reset=function(){$scope.mode=0,$scope.userList=[],$scope.prodList=[],$scope.pageIndex=1,$scope.pageSize=new Number(10),initQ=initFunction(),$scope.sort_flag="0"},$scope.reset(),$scope.research=function(){$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.resetCharge=function(){$scope.loading=!0,$scope.chargeUserKeyWord="",$scope.chargeProdKeyWord="",$scope.chargeUserList=[],$scope.chargeProdList=[],$scope.chargeUserData=[],$scope.chargeProdData=[],initChargeUserQ=initChargeUser(),initChargeProdQ=initChargeProd(),$q.all([initChargeUserQ,initChargeProdQ])["finally"](function(){$scope.loading=!1})},$scope.sort=function(){$scope.sort_flag="1"==$scope.sort_flag?"0":"1",$scope.research()},$scope.goToNextStep=function(){$scope.mode=1,$scope.resetCharge()},$scope.backToFistStep=function(){$scope.mode=0,$scope.research()},$scope.selectUser=function(user){$scope.currentUser=user,$scope.research()},$scope.selectProd=function(prod){$scope.currentProd=prod,$scope.research()},$scope.selectChargeUser=function(user){$scope.chargeUserList._select=user},$scope.searcher=function(index,size){if(!$scope.refreshing)return $scope.refreshing=!0,initQ.then(function(){return $scope.ajax("charge_get",{pageindex:index||$scope.pageIndex,pagesize:size||$scope.pageSize,isv_user_id:$scope.currentUser.user_id?$scope.currentUser.user_id:"",product_id:$scope.currentProd.product_id?$scope.currentProd.product_id:"",sort_name:"rx_insertTime",sort_flag:$scope.sort_flag}).then(function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?($scope.data_list=data.data_list,$scope.total=data.list_count):($rootScope.alert(data.msg),$scope.total=0)})["finally"](function(){$scope.refreshing=!1})})},$scope.researchChargeUser=function(){return initChargeUserQ.then(function(){var _select=$scope.chargeUserList._select;return $scope.chargeUserList=[].concat.apply([],$scope.chargeUserData.map(function(r){return r.user_name.indexOf($scope.chargeUserKeyWord)!=-1?[r]:[]})),$scope.chargeUserList._select=_select,$scope.chargeUserList})},$scope.researchChargeProd=function(){return initChargeUserQ.then(function(){var _select=$scope.chargeProdList._select;return $scope.chargeProdList=[].concat.apply([],$scope.chargeProdData.map(function(r){return r.product_name.indexOf($scope.chargeProdKeyWord)!=-1?[r]:[]})),$scope.chargeProdList._select=_select,$scope.chargeProdList})};var ResultController=function(scope,user,list){scope.user=user,scope.prodList=list,scope.save=function(){if(!scope.refreshing){if(0===scope.prodList.length)return scope.close(),void $scope.backToFistStep();scope.refreshing=!0;var myList=[];return scope.prodList.forEach(function(prod){var item={product_id:prod.product_id,product_price:prod.priceResult.price,product_amount:prod.priceResult.amount,price_count:prod.count};myList.push(item)}),$http.post("/agent",{module:"application",partial:$rootScope.tab.key,api:"charge_detail_save",param:{isv_user_id:scope.user.user_id,product_list:myList}}).then(function(body){return"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?(scope.close(),void $scope.backToFistStep()):$q.reject(body.data.msg)},function(why){return scope.error=why,$q.reject(why)})["finally"](function(){scope.refreshing=!1})}},scope.close=function(){return $mdDialog.hide()}};$scope.showResult=function(ev){if(!$scope.refreshing){if($scope.chargeForm.$invalid)return $scope.chargeForm.$error.required&&$scope.chargeForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$scope.chargeForm.$error.pattern&&$scope.chargeForm.$error.pattern.forEach(function(r){r.$setDirty(!0)}),$scope.chargeForm.$error.maxlength&&$scope.chargeForm.$error.maxlength.forEach(function(r){r.$setDirty(!0)}),void($scope.chargeForm.$error.email&&$scope.chargeForm.$error.email.forEach(function(r){r.$setDirty(!0)}));var list=$scope.chargeProdList.filter(function(item){return"1"===item.checked});$mdDialog.show({controller:ResultController,template:'\n                            <md-dialog aria-label="产品授权内容" class="info-table">\n                                <md-toolbar>\n                                    <div class="md-toolbar-tools">\n                                        <md-button class="md-icon-button md-primary md-hue-1" aria-label="Settings">\n                                            <md-icon md-svg-icon="content:ic_archive_24px"></md-icon>\n                                        </md-button>\n                                        <h3 flex><span>产品授权内容</span></h3>\n                                        <md-button class="md-icon-button md-primary md-hue-1" aria-label="Settings" ng-click="close()">\n                                            <md-icon md-svg-icon="content:ic_clear_24px"></md-icon>\n                                        </md-button>\n                                    </div>\n                                </md-toolbar>\n                                <md-dialog-content>\n                                    <div class="md-dialog-content">\n                                        <div class="header-container">\n                                            <table cellspacing="0" class="md-datatable">\n                                                <thead>\n                                                    <tr>\n                                                        <th><span>授权用户</span></th>\n                                                        <th><span>授权产品</span></th>\n                                                        <th><span>充值金额（元）</span></th>\n                                                        <th><span>充值调用次数</span></th>\n                                                    </tr>\n                                                </thead>\n                                            </table>\n                                        </div>\n                                        <div class="scroller">\n                                            <table cellspacing="0" class="md-datatable">\n                                                <tbody>\n                                                    <tr ng-repeat="prod in prodList track by $index">\n                                                        <td><span ng-bind="user.user_name"></span></td>\n                                                        <td><span ng-bind="prod.product_name"></span></td>\n                                                        <td><span ng-bind="prod.priceResult.price * prod.count"></span></td>\n                                                        <td><span ng-bind="prod.priceResult.amount * prod.count"></span></td>\n                                                    </tr>\n                                                </tbody>\n                                            </table>\n                                            <div class="message" ng-if="prodList.length === 0" style="color: #ff7c7c;font-size: 12px; margin-top: 8px;">\n                                                <span >请选择要授权产品</span>\n                                            </div>\n                                        </div>\n                                    </div>\n                                    </md-dialog-content>\n                                    <md-dialog-actions layout="row">\n                                        <md-button ng-click="close()" type="submit">取消</md-button>\n                                        <md-button ng-click="save()" type="submit" >保存</md-button>\n                                    </md-dialog-actions>\n                                </md-dialog>\n                    ',parent:angular.element("body>section>md-content"),targetEvent:ev,clickOutsideToClose:!0,locals:{user:$scope.chargeUserList._select,list:list}})}},window.test=$scope,$scope.$watch(function(){return $scope.mode},function(mode){mode?$rootScope.globalBack=globalBack:$rootScope.globalBack=null});var globalBack=function(){$scope.refreshing||$scope.refreshingUser||$scope.refreshingProd||$scope.loading||$scope.backToFistStep()};$scope.$on("$destroy",function(event){$rootScope.globalBack=null})}]});