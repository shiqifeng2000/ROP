"use strict";define([],function(){return["$rootScope","$scope","$http","$mdDialog","MiscTool","$location",function($rootScope,$scope,$http,$mdDialog,MiscTool,$location){$scope.mode=0,$scope.enterMode=function(mode,cb){$scope.mode=mode,cb&&cb.call()},$scope.exitMode=function(cb){$scope.mode=0,cb&&cb.call()},$scope.panelSelection={};var initName={id:"",name:"全部"},initType={type_id:"",type_name:"全部分类"},mainQ=$scope.ajax("init",function(data){$scope.originalPanel=JSON.parse(JSON.stringify(data)),$scope.panel=data});$scope.reset=function(){$scope.columns=[{text:"产品名称",name:"product_name"},{text:"产品分类",name:"product_type_name",style:{width:"128px","text-align":"center"}},{text:"添加时间",name:"create_time",sort:"1",style:{width:"184px","text-align":"center"}},{text:"显示产品价格",name:"price_list",formatter:function(array){return array.map(function(item){return"价格："+item.price+", 数量："+item.amount}).join(";")},tooltip:"price_list"}],$scope.product_keyword="",mainQ.then(function(){$scope.panelSelection.panelName=initName,$scope.panelSelection.panelType=initType,$scope.panelSelection.sorter={name:"",sort:"0"},$scope.columns=[{text:"产品名称",name:"product_name"},{text:"产品分类",name:"product_type_name",style:{width:"128px","text-align":"center"}},{text:"添加时间",name:"create_time",sort:"0",style:{width:"184px","text-align":"center"}},{text:"显示产品价格",name:"price_list",formatter:function(array){return array.map(function(item){return"价格："+item.price+", 数量："+item.amount}).join("； ")},tooltip:"price_list"}],$scope.product_type="",$scope.pageIndex=1,$scope.pageSize=new Number(10)})},$scope.reset(),$scope.chooseName=function(nameObj){$scope.panelSelection.panelName=nameObj||initName,$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.searcher=function(index,size){return mainQ.then(function(){$scope.refreshing=!0;var previous=$scope.tableData&&$scope.tableData._select;return $scope.ajax("list",{pageindex:index||$scope.pageIndex,pagesize:size||$scope.pageSize,product_name:$scope.product_keyword,product_type:$scope.panelSelection.panelType.type_id,sort_name:$scope.panelSelection.sorter.name&&"create_time"!=$scope.panelSelection.sorter.name?$scope.panelSelection.sorter.name:"rx_insertTime",sort_flag:$scope.panelSelection.sorter.sort},function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?($scope.tableData=data.data_list,$scope.total=data.list_count,$scope.tableData&&$scope.tableData[0]&&(previous?$scope.tableData._select=[].concat.apply([],$scope.tableData.map(function(r){return previous.product_id==r.product_id?[r]:[]}))[0]:$scope.tableData._select=$scope.tableData[0])):($rootScope.alert(data.msg),$scope.total=0)},function(){$scope.total=0})["finally"](function(){$scope.refreshing=!1})})},$scope.tableData=[],$scope.research=function(){$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.canVisistProduct=function(){return $scope.tableData&&$scope.tableData._select},$scope.canInsertProduct=function(){return $rootScope.validateBtnRole("btnInsert")},$scope.canDeleteProduct=function(array){return!!(array&&array.length&&array[0]&&$rootScope.validateBtnRole("btnDelete"))},$scope.canUpdateProduct=function(array){return!!(array&&array.length&&array[0]&&$rootScope.validateBtnRole("btnUpdate"))},$scope.deleteProduct=function(row){return $rootScope.confirm("请确认是否要删除产品？",function(){return $scope.ajax("delete",{product_id:row.product_id},function(data){$scope.research(),$rootScope.warn("删除成功",1)})})},$scope.chooseType=function(cat,selection){selection&&(selection.panelType=cat||initType),$scope.pageIndex=1,$scope.pageSize=new Number(10)};var initialUpdaterProduct={product_name:"",remark:""},initialSteps=[{name:"基本信息"},{name:"API列表"},{name:"产品定价"}];$scope.updaterProduct=JSON.parse(JSON.stringify(initialUpdaterProduct)),$scope.step=0,$scope.steps=initialSteps,$scope.updaterSelection={panelType:initType,api_list:[]},$scope.updateProductMode=function(row,forview){mainQ.then(function(data){return $scope.ajax("detail",{product_id:row.product_id},function(data){$scope.mode=1,0!=$scope.step&&($scope.step=0),$scope.steps=initialSteps,$scope.updaterProduct=data,$scope.updaterProduct.product_info&&$scope.updaterProduct.product_info.product_type?$scope.updaterSelection.panelType=[].concat.apply([],$scope.panel.product_type.map(function(r){return r.type_id==$scope.updaterProduct.product_info.product_type?[r]:[]}))[0]:$scope.updaterSelection.panelType=$scope.panel.product_type[0],$scope.updaterProduct._product_api_list=data.product_api_list?JSON.parse(JSON.stringify(data.product_api_list)):[],$scope.updaterProduct._api_list=data.api_list?JSON.parse(JSON.stringify(data.api_list)):[],!$scope.updaterProduct.price_list&&($scope.updaterProduct.price_list=[{},{}]),$scope.updaterProduct._forView=forview})},function(e){$rootScope.alert(e)})},$scope.nextStep=function(){return $scope.updaterProduct._forView?void($scope.step<2&&$scope.step++):$scope.updaterProductForm.$invalid?void($scope.updaterProductForm.$error.required&&$scope.updaterProductForm.$error.required.forEach(function(r){r.$setDirty(!0)})):void($scope.step<2&&$scope.step++)},$scope.previousStep=function(){$scope.step>0&&$scope.step--},$scope.cancelStep=function(){$scope.updaterProduct=JSON.parse(JSON.stringify(initialUpdaterProduct)),$scope.updaterProductForm.$setPristine(),$scope.mode=0,$scope.step=0,$scope.updaterSelection={panelType:initType,api_list:[]}},$scope.appendAPI=function(row){$scope.appendRow(row,$scope.updaterProduct._product_api_list),MiscTool.append([],"#choosenApiScroller"),MiscTool.splice($scope.updaterProduct._api_list,row,"#candidateApiScroller")},$scope.removeAPI=function(row){MiscTool.splice($scope.updaterProduct._product_api_list,row,"#choosenApiScroller"),MiscTool.append([],"#candidateApiScroller"),$scope.appendRow(row,$scope.updaterProduct._api_list)},$scope.appendRow=function(row,list){list.push(row&&list.indexOf(row)==-1?row:{})},$scope.locator=function(key,list,selector){var $el=angular.element(selector).eq(0),index=[].concat.apply([],list.map(function(r,i){return r.api_name.indexOf(key)!=-1||r.api_title.indexOf(key)!=-1?[i]:[]}))[0];$el.animate({scrollTop:40*index})},$scope.append=function(list,selector){$rootScope.throttle(MiscTool.append,600)(list,selector)},$scope.splice=function(list,row,selector){$rootScope.throttle(MiscTool.splice,600)(list,row,selector)},$scope.saveProduct=function(){if(!$scope.refreshing){if(!$scope.updaterProduct)return void $scope.alert("没有初始化数据");if($scope.updaterProductForm.$invalid)return void($scope.updaterProductForm.$error.required&&$scope.updaterProductForm.$error.required.forEach(function(r){r.$setDirty(!0)}));var product={product_id:$scope.updaterProduct.product_info.product_id,product_name:$scope.updaterProduct.product_info.product_name,product_type:$scope.updaterSelection.panelType.type_id,remark:$scope.updaterProduct.product_info.remark,price_list:[].concat.apply([],$scope.updaterProduct.price_list.map(function(r){return r.price&&r.amount?[{id:r.id,product_price:r.price,product_amount:r.amount}]:[]})),api_list:$scope.updaterProduct._product_api_list};return product.product_name&&product.product_type&&product.remark?product.api_list&&product.api_list.length?product.price_list&&product.price_list.length?$scope.ajax("save",product).then(function(data){$scope.refreshing=!1,$scope.exitMode(),$scope.step=0,product.product_id?$scope.searcher():$scope.research(),$scope.updaterProductForm.$setPristine(),$scope.updaterProduct=JSON.parse(JSON.stringify(initialUpdaterProduct)),$rootScope.warn("操作成功",1)},function(why){$scope.refreshing=!1}):void $scope.alert("价格不能为空"):void $scope.alert("API不能为空"):void $scope.alert("基本信息不能为空")}},window.test=$scope,$scope.$watch(function(){return $scope.mode},function(mode){mode?$rootScope.globalBack=globalBack:$rootScope.globalBack=null});var globalBack=function(){$scope.refreshing||$scope.exitMode()};$scope.$on("$destroy",function(event){$rootScope.globalBack=null})}]});